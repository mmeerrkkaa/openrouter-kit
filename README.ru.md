# OpenRouter Kit

[![–í–µ—Ä—Å–∏—è npm](https://badge.fury.io/js/openrouter-kit.svg)](https://badge.fury.io/js/openrouter-kit) [![–õ–∏—Ü–µ–Ω–∑–∏—è: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT) [![TypeScript](https://img.shields.io/badge/%3C/%3E-TypeScript-%230074C1.svg)](http://www.typescriptlang.org/)

**üá∑üá∫ –†—É—Å—Å–∫–∏–π** | [üá¨üáß English](./README.en.md)
---

**OpenRouter Kit** ‚Äî —ç—Ç–æ –º–æ—â–Ω–∞—è, –≥–∏–±–∫–∞—è –∏ —É–¥–æ–±–Ω–∞—è TypeScript/JavaScript –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å [OpenRouter API](https://openrouter.ai/). –û–Ω–∞ —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å LLM, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è API –¥–ª—è —á–∞—Ç–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π, –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (function calling) –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
npm install openrouter-kit
# –∏–ª–∏
yarn add openrouter-kit
# –∏–ª–∏
pnpm add openrouter-kit
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É:

### 1. –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞

–°–∞–º—ã–π –±–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏.

```typescript
// simple-chat.ts
import { OpenRouterClient } from 'openrouter-kit';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç —Å –≤–∞—à–∏–º API –∫–ª—é—á–æ–º
const client = new OpenRouterClient({
  apiKey: process.env.OPENROUTER_API_KEY || 'sk-or-v1-...',
  model: "google/gemini-2.0-flash-001" // –ú–æ–¥–µ–ª—å –¥–ª—è –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ
});

async function main() {
  try {
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞...');
    const result = await client.chat({
      prompt: '–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è README.',
      model: 'google/gemini-1-5', // –µ—Å–ª–∏ –Ω–µ –±—É–¥–µ—Ç —Å—Ç—Ä–æ—á–∫–∏ —Å –º–æ–¥–µ–ª—å—é, —Ç–æ –¥–µ—Ñ–æ–ª—Ç –º–æ–¥–µ–ª—å —É–∫–∞–∑–∞–Ω–Ω–∞—è –≤—ã—à–µ. –ï—Å–ª–∏ –µ—Å—Ç—å, —Ç–æ —Ç–µ–∫—É—â–∏–π –≤—ã–∑–æ–≤ –±—É–¥–µ—Ç —Å —ç—Ç–æ–π—Ñ –º–æ–¥–µ–ª—å—é
      temperature: 0.7,
    });

    console.log('--- –†–µ–∑—É–ª—å—Ç–∞—Ç ---');
    console.log('–û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏:', result.content);
    console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å:', result.model);
    console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤:', result.usage);

  } catch (error: any) {
    console.error(`\n--- –û—à–∏–±–∫–∞ ---`);
    console.error(`–°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`);
  } finally {
    console.log('\n–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...');
    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã (—Ç–∞–π–º–µ—Ä—ã –∏ —Ç.–¥.)
    await client.destroy();
  }
}

main();
```

### 2. –ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞ (—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–µ–π)

–ß—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `historyAdapter` –∏ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ `user` ID. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é.

```typescript
// dialog-chat.ts
import { OpenRouterClient, MemoryHistoryStorage } from 'openrouter-kit';

const client = new OpenRouterClient({
  apiKey: process.env.OPENROUTER_API_KEY || 'sk-or-v1-...',
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º MemoryHistoryStorage –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ –ø–∞–º—è—Ç–∏
  historyAdapter: new MemoryHistoryStorage(),
  enableCostTracking: true,
});

const userId = 'dialog-user-123'; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

async function runDialog() {
  try {
    // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    console.log(`[${userId}] –í—ã: –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?`);
    const result1 = await client.chat({
      user: userId, // <-- –ü–µ—Ä–µ–¥–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π
      prompt: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?',
      model: 'google/gemini-2.0-flash-001',
    });
    console.log(`[${userId}] –ë–æ—Ç: ${result1.content}`);
    console.log(`(–°—Ç–æ–∏–º–æ—Å—Ç—å: $${result1.cost?.toFixed(6) || 'N/A'})`);

    // –í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –ø–æ–º–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç)
    console.log(`\n[${userId}] –í—ã: –ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è?`);
    const result2 = await client.chat({
      user: userId, // <-- –¢–æ—Ç –∂–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      prompt: '–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è?',
      model: 'google/gemini-flash-1.5',
    });
    console.log(`[${userId}] –ë–æ—Ç: ${result2.content}`);
    console.log(`(–°—Ç–æ–∏–º–æ—Å—Ç—å: $${result2.cost?.toFixed(6) || 'N/A'})`);

    // –ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    const historyManager = client.getHistoryManager();
    const historyKey = `user:${userId}`; // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ (–º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
    const history = await historyManager.getHistory(historyKey);
    console.log(`\n–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è ${historyKey}: ${history.length}`);

  } catch (error: any) {
    console.error(`\n--- –û—à–∏–±–∫–∞ ---`);
    console.error(`–°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`);
    if (error.code) console.error(`–ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code}`);
  } finally {
    console.log('\n–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –¥–∏–∞–ª–æ–≥–∞...');
    await client.destroy();
  }
}

runDialog();
```

### 3. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (Tools / Function Calling)

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ó–¥–µ—Å—å –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫—É, –∞ –∑–∞—Ç–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

```javascript
// tools-example.js (CommonJS)
const { OpenRouterClient, MemoryHistoryStorage } = require("openrouter-kit");

const users = [
  { id: "user_1001", nick: "alice" },
  { id: "user_1002", nick: "bob" },
  { id: "user_1003", nick: "charlie" },
  { id: "user_1004", nick: "david" },
  { id: "user_1005", nick: "elena" }
];

const messages = [
  { id: "msg_101", userId: "user_1001", content: "1" },
  { id: "msg_102", userId: "user_1002", content: "2" },
  { id: "msg_103", userId: "user_1003", content: "3" },
  { id: "msg_104", userId: "user_1004", content: "4" },
  { id: "msg_105", userId: "user_1005", content: "5" },
  { id: "msg_106", userId: "user_1001", content: "6" },
  { id: "msg_107", userId: "user_1002", content: "7" }
];

const userTools = [
  {
    type: "function",
    function: {
      name: "getUserIdByNick",
      description: "–ü–æ–ª—É—á–∞–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ –Ω–∏–∫–Ω–µ–π–º—É",
      parameters: {
        type: "object",
        properties: {
          nick: { type: "string", description: "–ù–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" }
        },
        required: ["nick"]
      },
    },
    execute: async (args) => {
      console.log(`[getUserIdByNick] –∞—Ä–≥—É–º–µ–Ω—Ç—ã ${args.nick}...`);
      const user = users.find(u => u.nick.toLowerCase() === args.nick.toLowerCase());
      if (user) {
        return { userId: user.id, nick: args.nick, found: true };
      } else {
        return { userId: null, nick: args.nick, found: false };
      }
    }
  },
  {
    type: "function",
    function: {
      name: "getMessageById",
      description: "–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ ID",
      parameters: {
        type: "object",
        properties: {
          messageId: { type: "string", description: "ID —Å–æ–æ–±—â–µ–Ω–∏—è" }
        },
        required: ["messageId"]
      },
    },
    execute: async (args) => {
      console.log(`[getMessageById] –∞—Ä–≥—É–º–µ–Ω—Ç—ã ${args.messageId}...`);
      const message = messages.find(m => m.id === args.messageId);
      if (message) {
        return { 
          messageId: args.messageId, 
          content: message.content, 
          userId: message.userId,
          found: true 
        };
      } else {
        return { 
          messageId: args.messageId, 
          content: "–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", 
          userId: null,
          found: false 
        };
      }
    }
  },
  {
    type: "function",
    function: {
      name: "getUserMessages",
      description: "–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ ID",
      parameters: {
        type: "object",
        properties: {
          userId: { type: "string", description: "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" }
        },
        required: ["userId"]
      },
    },
    execute: async (args) => {
      console.log(`[getUserMessages] –∞—Ä–≥—É–º–µ–Ω—Ç—ã ${args.userId}...`);
      const userMessages = messages.filter(m => m.userId === args.userId);
      if (userMessages.length > 0) {
        return { 
          userId: args.userId,
          messages: userMessages,
          count: userMessages.length,
          found: true 
        };
      } else {
        return { 
          userId: args.userId,
          messages: [],
          count: 0,
          found: false 
        };
      }
    }
  }
];

const client = new OpenRouterClient({
  apiKey: "sk-or-v1-",
  model: "openrouter/quasar-alpha",
});

async function main() {
    const result = await client.chat({
        systemPrompt: '–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç',
        prompt: '—á—Ç–æ –ø–∏—Ç—Å–∞–ª–∞ alice',
        tools: userTools,
        temperature: 0.5,
    });
    console.log(result.content);

    const result2 = await client.chat({
        systemPrompt: '–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç',
        prompt: '—á—Ç–æ –ø–∏—Å–∞–ª dasda',
        tools: userTools,
        temperature: 0.5,
    });
    console.log(result2.content);
}

main();

```

---

## üìö –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã —É–≤–∏–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –≤—ã –º–æ–∂–µ—Ç–µ —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

### –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

*   [üåü –ó–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenRouter Kit?](#-–∑–∞—á–µ–º-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å-openrouter-kit)
*   [üöÄ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#-–∫–ª—é—á–µ–≤—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
*   [üöï –ü—Ä–∏–º–µ—Ä: –¢–∞–∫—Å–∏-–±–æ—Ç](#-–ø—Ä–∏–º–µ—Ä-—Ç–∞–∫—Å–∏-–±–æ—Ç)
*   [‚öôÔ∏è API –∏ –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏](#Ô∏è-api-–∏-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
    *   [OpenRouterClient](#openrouterclient)
        *   [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (OpenRouterConfig)](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-openrouterconfig)
        *   [–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–º–µ—Ç–æ–¥—ã)
    *   [–ü–ª–∞–≥–∏–Ω—ã –∏ Middleware](#-–ø–ª–∞–≥–∏–Ω—ã-–∏-middleware)
    *   [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π (–ê–¥–∞–ø—Ç–µ—Ä—ã)](#-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–∏—Å—Ç–æ—Ä–∏–µ–π-–∞–¥–∞–ø—Ç–µ—Ä—ã)
    *   [–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (Function Calling)](#-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤-function-calling)
    *   [–ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (SecurityManager)](#-–º–æ–¥—É–ª—å-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏-securitymanager)
    *   [–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Cost Tracking)](#-–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ-—Å—Ç–æ–∏–º–æ—Å—Ç–∏-cost-tracking)
    *   [–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (responseFormat)](#Ô∏è-—Ñ–æ—Ä–º–∞—Ç-–æ—Ç–≤–µ—Ç–∞-responseformat)
    *   [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#Ô∏è-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
    *   [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
    *   [–ü—Ä–æ–∫—Å–∏](#-–ø—Ä–æ–∫—Å–∏)
*   [üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è](#-–ª–∏—Ü–µ–Ω–∑–∏—è)

### üåü –ó–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenRouter Kit?

*   **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –°–ª–æ–∂–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–∫—Ä—ã—Ç—ã –∑–∞ –ø—Ä–æ—Å—Ç—ã–º –º–µ—Ç–æ–¥–æ–º `client.chat()`.
*   **–ì–∏–±–∫–æ—Å—Ç—å:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –º–æ–¥–µ–ª–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, **—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–µ—Ä)**, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞—â–∏—Ç–∏—Ç—å –≤–∞—à–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
*   **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–∞–≥–∏–Ω—ã –∏ middleware –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ª–æ–≥–∏–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–¥—Ä–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
*   **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –Ω–∞ TypeScript, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–≤–∫–ª—é—á–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤) –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏.

### üöÄ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   **ü§ñ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —á–∞—Ç:** –ü—Ä–æ—Å—Ç–æ–π –∏ –º–æ—â–Ω—ã–π API (`client.chat`) –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ª—é–±–æ–π –º–æ–¥–µ–ª—å—é, –¥–æ—Å—Ç—É–ø–Ω–æ–π —á–µ—Ä–µ–∑ OpenRouter.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç `ChatCompletionResult` —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º (`content`), –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞—Ö (`usage`), –º–æ–¥–µ–ª—å—é (`model`), –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (`toolCallsCount`), –ø—Ä–∏—á–∏–Ω–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (`finishReason`), –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`durationMs`), ID –∑–∞–ø—Ä–æ—Å–∞ (`id`) –∏ **—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é** (`cost`, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
*   **üìú –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π (—á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä—ã):** **–¢—Ä–µ–±—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `historyAdapter`**. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ) –æ–±—Ä–µ–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `user` –≤ `client.chat()`.
    *   –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –±–∞–∑–µ **–∞–¥–∞–ø—Ç–µ—Ä–æ–≤** (`IHistoryStorage`).
    *   –í –∫–æ–º–ø–ª–µ–∫—Ç–µ ‚Äî –∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –ø–∞–º—è—Ç–∏ (`MemoryHistoryStorage`) –∏ –¥–∏—Å–∫–∞ (`DiskHistoryStorage`, JSON-—Ñ–∞–π–ª—ã). –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è.
    *   –õ–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Å–≤–æ–∏ –∞–¥–∞–ø—Ç–µ—Ä—ã (Redis, MongoDB, API –∏ –¥—Ä.) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–≥–∏–Ω (`createRedisHistoryPlugin`).
    *   –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL –∫—ç—à–∞ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ —á–µ—Ä–µ–∑ –æ–ø—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (`historyTtl`, `historyCleanupInterval`). –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–æ –∞–¥–∞–ø—Ç–µ—Ä—É.
*   **üõ†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (Function Calling):** –ë–µ—Å—à–æ–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ –≤–∞—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –º–æ–¥–µ–ª—å—é.
    *   –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é `Tool` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ JSON Schema –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.
    *   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Å—Ö–µ–º–µ –∏ **–ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**.
    *   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–∞—à–∏—Ö `execute` —Ñ—É–Ω–∫—Ü–∏–π —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`ToolContext`, –≤–∫–ª—é—á–∞—è `userInfo`).
    *   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    *   **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:** –û—à–∏–±–∫–∏, –≤–æ–∑–Ω–∏–∫—à–∏–µ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ, –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –≤ –≤–∏–¥–µ JSON-—Å—Ç—Ä–æ–∫–∏ (`{"errorType": "...", "errorMessage": "...", "details": ...}`) –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –º–æ–¥–µ–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ `role: 'tool'`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç LLM –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –∏ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É.
    *   –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ª–∏–º–∏—Ç –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—É–Ω–¥–æ–≤ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (`maxToolCalls`) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è.
*   **üõ°Ô∏è –ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –≤–∞—à–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.
    *   **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JWT (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ) —á–µ—Ä–µ–∑ `AuthManager`. –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ (`api-key`, `custom`).
    *   **–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ (ACL):** –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º (`AccessControlManager`) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π (`roles`), API-–∫–ª—é—á–µ–π (`allowedApiKeys`), —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (`scopes`) –∏–ª–∏ —è–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª (`allow`/`deny`). –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`deny-all`/`allow-all`).
    *   **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã (Rate Limiting):** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ (`RateLimitManager`) –Ω–∞ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ —Ä–æ–ª–µ–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∏ –ª–∏–º–∏—Ç—ã. **–í–∞–∂–Ω–æ:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `RateLimitManager` —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ –∏ **–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º** (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤/—Å–µ—Ä–≤–µ—Ä–æ–≤). –î–ª—è —Ç–∞–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä –∏–ª–∏ –ø–ª–∞–≥–∏–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Redis).
    *   **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤:** –ü—Ä–æ–≤–µ—Ä–∫–∞ (`ArgumentSanitizer`) –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (SQLi, XSS, command injection –∏ —Ç.–¥.) —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–∞ –∞—É–¥–∏—Ç–∞ (`auditOnlyMode`).
    *   **–°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π:** –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`access:denied`, `ratelimit:exceeded`, `security:dangerous_args`, `token:invalid`, `user:authenticated` –∏ –¥—Ä.) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
*   **üìà –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Cost Tracking):** (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    *   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ `chat()` –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞—Ö (`usage`) –∏ —Ü–µ–Ω –º–æ–¥–µ–ª–µ–π OpenRouter.
    *   –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –º–æ–¥–µ–ª–µ–π –∏–∑ API OpenRouter (`/models`).
    *   –ú–µ—Ç–æ–¥ `getCreditBalance()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ OpenRouter.
    *   –î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ü–µ–Ω–∞–º —á–µ—Ä–µ–∑ `getModelPrices()`.
*   **‚öôÔ∏è –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–∞, –º–æ–¥–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (`apiEndpoint` –¥–ª—è —á–∞—Ç–∞, –±–∞–∑–æ–≤—ã–π URL –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏), —Ç–∞–π–º–∞—É—Ç–æ–≤, **–ø—Ä–æ–∫—Å–∏**, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (`Referer`, `X-Title`), —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (`modelFallbacks`), —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (`responseFormat`), –ª–∏–º–∏—Ç–∞ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (`maxToolCalls`), –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (`enableCostTracking`), **–∞–¥–∞–ø—Ç–µ—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ (`historyAdapter`)** –∏ –º–Ω–æ–≥–∏—Ö –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ `OpenRouterConfig`.
*   **üí° –¢–∏–ø–∏–∑–∞—Ü–∏—è:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ TypeScript, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Å—Ç—Ä–æ–≥—É—é —Ç–∏–ø–∏–∑–∞—Ü–∏—é, –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤ –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
*   **üö¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ü–æ–Ω—è—Ç–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –æ—à–∏–±–æ–∫ (`APIError`, `ValidationError`, `SecurityError`, `RateLimitError`, `ToolError`, `ConfigError` –∏ –¥—Ä.), –Ω–∞—Å–ª–µ–¥—É–µ–º—ã—Ö –æ—Ç `OpenRouterError`, —Å –∫–æ–¥–∞–º–∏ (`ErrorCode`) –∏ –¥–µ—Ç–∞–ª—è–º–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏. –§—É–Ω–∫—Ü–∏—è `mapError` –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫.
*   **üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≥–∏–±–∫–∏–π –ª–æ–≥–≥–µ—Ä (`Logger`) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –∏ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏ (`debug`).
*   **‚ú® –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π API, —Å–∫—Ä—ã–≤–∞—é—â–∏–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å –±–∞–∑–æ–≤—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å LLM, –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏.
*   **üßπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏:** –ú–µ—Ç–æ–¥ `client.destroy()` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (—Ç–∞–π–º–µ—Ä—ã –æ—á–∏—Å—Ç–∫–∏, –∫—ç—à–∏, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π), –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è —É—Ç–µ—á–∫–∏ –≤ –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.
*   **üß© –ü–ª–∞–≥–∏–Ω-—Å–∏—Å—Ç–µ–º–∞:** –†–∞—Å—à–∏—Ä—è–π—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–¥—Ä–∞.
    *   –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ —á–µ—Ä–µ–∑ `client.use(plugin)`.
    *   –ü–ª–∞–≥–∏–Ω—ã –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å middleware, –∑–∞–º–µ–Ω—è—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—ã (–∏—Å—Ç–æ—Ä–∏–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Å—Ç–æ–∏–º–æ—Å—Ç–∏), –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å API –∫–ª–∏–µ–Ω—Ç–∞.
*   **üîó Middleware-—Ü–µ–ø–æ—á–∫–∞:** –ì–∏–±–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ API.
    *   –î–æ–±–∞–≤–ª—è–π—Ç–µ middleware-—Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ `client.useMiddleware(fn)`.
    *   Middleware –º–æ–∂–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã (`ctx.request`), –æ—Ç–≤–µ—Ç—ã (`ctx.response`), —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—É–¥–∏—Ç, –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.

### üöï –ü—Ä–∏–º–µ—Ä: –¢–∞–∫—Å–∏-–±–æ—Ç

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. **–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `historyAdapter` –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `require`.**

```javascript
// taxi-bot.js (CommonJS)
const { OpenRouterClient, MemoryHistoryStorage } = require("openrouter-kit");
const readline = require('readline').createInterface({
  input: process.stdin,
  output: process.stdout
});

const client = new OpenRouterClient({
  apiKey: process.env.OPENROUTER_API_KEY || "sk-or-v1-...",
  model: "google/gemini-2.0-flash-001", // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å
  historyAdapter: new MemoryHistoryStorage(), // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
  enableCostTracking: true,
  debug: false, // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ true –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤
  // security: { /* ... */ } // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
});

let orderAccepted = false;

// --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ---
const taxiTools = [
  {
    type: "function",
    function: {
      name: "estimateRideCost",
      description: "–û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏ –Ω–∞ —Ç–∞–∫—Å–∏ –º–µ–∂–¥—É –¥–≤—É–º—è –∞–¥—Ä–µ—Å–∞–º–∏.",
      parameters: {
        type: "object",
        properties: {
          from: { type: "string", description: "–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—É–ª. –õ–µ–Ω–∏–Ω–∞, 1, –ú–æ—Å–∫–≤–∞')" },
          to: { type: "string", description: "–ê–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 10, –ú–æ—Å–∫–≤–∞')" }
        },
        required: ["from", "to"]
      },
    },
    execute: async (args) => {
      console.log(`[–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç estimateRideCost] –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ—Ç ${args.from} –¥–æ ${args.to}...`);
      const cost = Math.floor(Math.random() * 900) + 100;
      console.log(`[–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç estimateRideCost] –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${cost} RUB`);
      return { estimatedCost: cost, currency: "RUB" };
    }
  },
  {
    type: "function",
    function: {
      name: "acceptOrder",
      description: "–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Ç–∞–∫—Å–∏, –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è.",
      parameters: {
        type: "object",
        properties: {
          from: { type: "string", description: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è" },
          to: { type: "string", description: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" },
          estimatedCost: { type: "number", description: "–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–µ–∑–¥–∫–∏ (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞)"}
        },
        required: ["from", "to"]
      },
    },
    execute: async (args, context) => {
      console.log(`[–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç acceptOrder] –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –æ—Ç ${args.from} –¥–æ ${args.to}...`);
      console.log(`[–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç acceptOrder] –ó–∞–∫–∞–∑ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: ${context?.userInfo?.userId || 'anonymous'}`);
      const driverNumber = Math.floor(Math.random() * 100) + 1;
      orderAccepted = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–∏–∫–ª–∞
      return `–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç! –í–æ–¥–∏—Ç–µ–ª—å #${driverNumber} –Ω–∞–∑–Ω–∞—á–µ–Ω –∏ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç —É –≤–∞—Å –ø–æ –∞–¥—Ä–µ—Å—É ${args.from}. –ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${args.to}.`;
    }
  }
];

function askQuestion(query) {
  return new Promise((resolve) => {
    readline.question(query, (answer) => {
      resolve(answer);
    });
  });
}

const systemPrompt = `–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–ª—É–∂–±—ã —Ç–∞–∫—Å–∏ –ø–æ –∏–º–µ–Ω–∏ "–ö–∏—Ç". –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É –∑–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏.
1. –£—Ç–æ—á–Ω–∏ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è ('from') –∏ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è ('to'), –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏—Ö –Ω–µ —É–∫–∞–∑–∞–ª. –ë—É–¥—å –≤–µ–∂–ª–∏–≤.
2. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 'estimateRideCost', —á—Ç–æ–±—ã —Å–æ–æ–±—â–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏–º–µ—Ä–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å.
3. –î–æ–∂–¥–∏—Å—å, –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç, —á—Ç–æ –µ–≥–æ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –æ–Ω –≥–æ—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–æ–≤–∞–º–∏ "–∑–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ", "—Ö–æ—Ä–æ—à–æ", "–¥–∞", "–ø–æ–¥—Ö–æ–¥–∏—Ç").
4. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 'acceptOrder', –ø–µ—Ä–µ–¥–∞–≤ –µ–º—É –∞–¥—Ä–µ—Å–∞ 'from' –∏ 'to'.
5. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ 'acceptOrder' —Å–æ–æ–±—â–∏ –∫–ª–∏–µ–Ω—Ç—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–µ—Ä–Ω—É–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.
6. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–º–µ—Ä–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏–ª–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å–∞–º, –ø–æ–ª–∞–≥–∞–π—Å—è –Ω–∞ –æ—Ç–≤–µ—Ç –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ 'acceptOrder'.
7. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ –Ω–µ –ø–æ —Ç–µ–º–µ –∑–∞–∫–∞–∑–∞ —Ç–∞–∫—Å–∏, –≤–µ–∂–ª–∏–≤–æ –≤–µ—Ä–Ω–∏ –µ–≥–æ –∫ —Ç–µ–º–µ.`;

async function chatWithTaxiBot() {
  const userId = `taxi-user-${Date.now()}`;
  console.log(`\n–ë–æ—Ç –ö–∏—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫... (ID —Å–µ—Å—Å–∏–∏: ${userId})`);

  try {
    while (!orderAccepted) {
      const userMessage = await askQuestion("–í—ã: ");
      if (userMessage.toLowerCase() === '–≤—ã—Ö–æ–¥' || userMessage.toLowerCase() === 'quit') {
          console.log("–ë–æ—Ç –ö–∏—Ç: –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ! –î–æ —Å–≤–∏–¥–∞–Ω–∏—è.");
          break;
      }

      console.log("–ë–æ—Ç –ö–∏—Ç: –ú–∏–Ω—É—Ç–∫—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å...");
      const result = await client.chat({
        user: userId, // –ö–ª—é—á –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        prompt: userMessage,
        systemPrompt: systemPrompt,
        tools: taxiTools, // –ü–µ—Ä–µ–¥–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        temperature: 0.5,
        maxToolCalls: 5 // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
      });

      // –í—ã–≤–æ–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
      console.log(`\n–ë–æ—Ç –ö–∏—Ç: ${result.content}\n`);

      // –í—ã–≤–æ–¥–∏–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
      if (client.isDebugMode()) {
          console.log(`[–û—Ç–ª–∞–¥–∫–∞] –ú–æ–¥–µ–ª—å: ${result.model}, –í—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä.: ${result.toolCallsCount}, –°—Ç–æ–∏–º–æ—Å—Ç—å: ${result.cost !== null ? '$' + result.cost.toFixed(8) : 'N/A'}, –ü—Ä–∏—á–∏–Ω–∞: ${result.finishReason}`);
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º acceptOrder
      if (orderAccepted) {
        console.log("–ë–æ—Ç –ö–∏—Ç: –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã, —è –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!");
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å break –∑–¥–µ—Å—å, –µ—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞
      }
    }
  } catch (error) {
    console.error("\n--- –ü—Ä–æ–∏–∑–æ—à–ª–∞ –û—à–∏–±–∫–∞ ---");
    if (error instanceof Error) {
        console.error(`–¢–∏–ø: ${error.constructor.name}`);
        console.error(`–°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`);
        if ((error as any).code) console.error(`–ö–æ–¥: ${(error as any).code}`);
        if ((error as any).statusCode) console.error(`–°—Ç–∞—Ç—É—Å: ${(error as any).statusCode}`);
        if ((error as any).details) console.error(`–î–µ—Ç–∞–ª–∏:`, (error as any).details);
    } else {
        console.error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞:", error);
    }
  } finally {
    readline.close();
    await client.destroy(); // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
    console.log("\n–ö–ª–∏–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
  }
}

chatWithTaxiBot();
```

### ‚öôÔ∏è API –∏ –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏

#### `OpenRouterClient`

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π.

##### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`OpenRouterConfig`)

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (`new OpenRouterClient(config)`) –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:

*   `apiKey` (string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): –í–∞—à API –∫–ª—é—á OpenRouter.
*   `apiEndpoint?` (string): URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –¥–ª—è —á–∞—Ç-–∫–æ–º–ø–ª–∏—à–µ–Ω–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `https://openrouter.ai/api/v1/chat/completions`).
*   `model?` (string): –ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤.
*   `debug?` (boolean): –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`).
*   `proxy?` (string | object): –ù–∞—Å—Ç—Ä–æ–π–∫–∏ HTTP/HTTPS –ø—Ä–æ–∫—Å–∏.
*   `referer?` (string): –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `HTTP-Referer`.
*   `title?` (string): –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Title`.
*   `axiosConfig?` (object): –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Axios.
*   `historyAdapter?` (IHistoryStorage): **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.** –≠–∫–∑–µ–º–ø–ª—è—Ä –∞–¥–∞–ø—Ç–µ—Ä–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `new MemoryHistoryStorage()`).
*   `historyTtl?` (number): –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ (TTL) –∑–∞–ø–∏—Å–µ–π –≤ –∫—ç—à–µ –∏—Å—Ç–æ—Ä–∏–∏ `UnifiedHistoryManager` (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö).
*   `historyCleanupInterval?` (number): –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ –∫—ç—à–∞ –∏—Å—Ç–æ—Ä–∏–∏ `UnifiedHistoryManager` (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö).
*   `providerPreferences?` (object): –ù–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –º–æ–¥–µ–ª–µ–π OpenRouter.
*   `modelFallbacks?` (string[]): –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Å–Ω–æ–≤–Ω–æ–π.
*   `responseFormat?` (ResponseFormat | null): –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
*   `maxToolCalls?` (number): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ `chat()` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10).
*   `strictJsonParsing?` (boolean): –í—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ (–µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω JSON —Ñ–æ—Ä–º–∞—Ç)? (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`).
*   `security?` (SecurityConfig): –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞–∑–æ–≤—ã–π —Ç–∏–ø `SecurityConfig` –∏–∑ `./types`).
*   `enableCostTracking?` (boolean): –í–∫–ª—é—á–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`).
*   `priceRefreshIntervalMs?` (number): –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –º–æ–¥–µ–ª–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6 —á–∞—Å–æ–≤).
*   `initialModelPrices?` (object): –ù–∞—á–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –º–æ–¥–µ–ª–µ–π –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Ü–µ–Ω.
*   *–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–æ–ª—è (–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `historyAdapter`):* `historyStorage`, `chatsFolder`, `maxHistoryEntries`, `historyAutoSave`.

##### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

*   `chat(options: OpenRouterRequestOptions): Promise<ChatCompletionResult>`: –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤ —á–∞—Ç. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç `options` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–∞ (—Å–º. `OpenRouterRequestOptions` –≤ `types/index.ts`). **–£–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏–µ–π, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `user` –∏ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω `historyAdapter`.**
*   `getHistoryManager(): UnifiedHistoryManager`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω).
*   `getSecurityManager(): SecurityManager | null`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω).
*   `getCostTracker(): CostTracker | null`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç—Ä–µ–∫–µ—Ä–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω).
*   `getCreditBalance(): Promise<CreditBalance>`: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤ OpenRouter.
*   `getModelPrices(): Record<string, ModelPricingInfo>`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—ç—à —Ü–µ–Ω –º–æ–¥–µ–ª–µ–π.
*   `refreshModelPrices(): Promise<void>`: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à —Ü–µ–Ω.
*   `createAccessToken(userInfo, expiresIn?): string`: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT (–µ—Å–ª–∏ `security.userAuthentication.type === 'jwt'`).
*   `use(plugin): Promise<void>`: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–≥–∏–Ω.
*   `useMiddleware(fn): void`: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç middleware.
*   `on(event, handler)` / `off(event, handler)`: –ü–æ–¥–ø–∏—Å–∫–∞/–æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π –∫–ª–∏–µ–Ω—Ç–∞ (`'error'`) –∏–ª–∏ –º–æ–¥—É–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Å–æ–±—ã—Ç–∏—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ `security:`, `user:`, `token:`, `access:`, `ratelimit:`, `tool:`).
*   `destroy(): Promise<void>`: –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã (—Ç–∞–π–º–µ—Ä—ã, —Å–ª—É—à–∞—Ç–µ–ª–∏).

#### üß© –ü–ª–∞–≥–∏–Ω—ã –∏ Middleware

*   **–ü–ª–∞–≥–∏–Ω—ã:** –ú–æ–¥—É–ª–∏, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `client.use(plugin)`. –ú–æ–≥—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã, –∑–∞–º–µ–Ω—è—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã (`setSecurityManager`, `setCostTracker`), –¥–æ–±–∞–≤–ª—è—Ç—å middleware.
*   **Middleware:** –§—É–Ω–∫—Ü–∏–∏, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ `client.chat()`. –ü–æ–∑–≤–æ–ª—è—é—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å (`ctx.request`), –æ—Ç–≤–µ—Ç (`ctx.response`) –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–±–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞—É–¥–∏—Ç). –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `client.useMiddleware(fn)`.

#### üìú –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π (–ê–¥–∞–ø—Ç–µ—Ä—ã)

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–æ–≤ (–∑–∞–≥—Ä—É–∑–∫–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ–±—Ä–µ–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ `user` –≤ `client.chat()`), **–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å `historyAdapter`** –≤ `OpenRouterConfig`. –ë–µ–∑ –Ω–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç.

*   **–ê–¥–∞–ø—Ç–µ—Ä (`IHistoryStorage`):** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (`load`, `save`, `delete`, `listKeys`, `destroy?`).
*   **`UnifiedHistoryManager`:** –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –∞–¥–∞–ø—Ç–µ—Ä –∏ —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ –ø–∞–º—è—Ç–∏ (—Å TTL –∏ –æ—á–∏—Å—Ç–∫–æ–π).
*   **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã:**
    *   `MemoryHistoryStorage`: –•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∞–¥–∞–ø—Ç–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω).
    *   `DiskHistoryStorage`: –•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ JSON-—Ñ–∞–π–ª–∞—Ö –Ω–∞ –¥–∏—Å–∫–µ.
*   **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:**
    ```typescript
    import { OpenRouterClient, MemoryHistoryStorage, DiskHistoryStorage } from 'openrouter-kit';

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MemoryHistoryStorage
    const clientMemory = new OpenRouterClient({
      /*...,*/
      historyAdapter: new MemoryHistoryStorage()
    });

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DiskHistoryStorage
    const clientDisk = new OpenRouterClient({
      /*...,*/
      historyAdapter: new DiskHistoryStorage('./my-chat-histories')
    });
    ```
*   **–ü–ª–∞–≥–∏–Ω –¥–ª—è Redis:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `createRedisHistoryPlugin` –¥–ª—è —É–¥–æ–±–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Redis (—Ç—Ä–µ–±—É–µ—Ç `ioredis`).
*   **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞:** `historyTtl`, `historyCleanupInterval` –≤ `OpenRouterConfig` —É–ø—Ä–∞–≤–ª—è—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º –∫—ç—à–∞ –≤ `UnifiedHistoryManager`.

#### üõ†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (Function Calling)

–ü–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–µ–ª—è–º LLM –≤—ã–∑—ã–≤–∞—Ç—å –≤–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ JavaScript/TypeScript –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–≥–∏–º–∏ API –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –º–∏—Ä–µ.

1.  **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (`Tool`):**
    –í—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–∞–∫ –æ–±—ä–µ–∫—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É `Tool`. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è:
    *   `type: 'function'` (–ø–æ–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø).
    *   `function`: –û–±—ä–µ–∫—Ç, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è LLM:
        *   `name` (string): –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤—ã–∑–æ–≤–∞.
        *   `description` (string, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ß–µ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è –∏ –∫–æ–≥–¥–∞ –µ–µ —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –≠—Ç–æ **–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ** –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞–ª–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
        *   `parameters` (object, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): [JSON Schema](https://json-schema.org/), –æ–ø–∏—Å—ã–≤–∞—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Ç–∏–ø—ã –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞–µ—Ç –≤–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É —Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ—Ç –º–æ–¥–µ–ª–∏. –ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–µ –Ω—É–∂–Ω—ã, —ç—Ç–æ –ø–æ–ª–µ –º–æ–∂–Ω–æ –æ–ø—É—Å—Ç–∏—Ç—å.
    *   `execute: (args: any, context?: ToolContext) => Promise<any> | any`: **–í–∞—à–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –∫–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏—Ç –≤—ã–∑–æ–≤ —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
        *   `args`: –û–±—ä–µ–∫—Ç —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—å—é, —É–∂–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º–∏ –∏–∑ JSON-—Å—Ç—Ä–æ–∫–∏ –∏ (–µ—Å–ª–∏ —Å—Ö–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞) –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ `parameters`.
        *   `context?`: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç `ToolContext`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–∑–æ–≤–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
            *   `userInfo?`: –û–±—ä–µ–∫—Ç `UserAuthInfo` —Å –¥–∞–Ω–Ω—ã–º–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SecurityManager` –∏ –ø–µ—Ä–µ–¥–∞–Ω `accessToken`).
            *   `securityManager?`: –≠–∫–∑–µ–º–ø–ª—è—Ä `SecurityManager` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
    *   `security` (ToolSecurity, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –û–±—ä–µ–∫—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç–∞–∫–∏—Ö –∫–∞–∫ `requiredRole`, `requiredScopes` –∏–ª–∏ `rateLimit`. –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è `SecurityManager` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `execute`.

2.  **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `client.chat()`:**
    *   –ü–µ—Ä–µ–¥–∞–π—Ç–µ –º–∞—Å—Å–∏–≤ –≤–∞—à–∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –æ–ø—Ü–∏—é `tools` –º–µ—Ç–æ–¥–∞ `client.chat()`.
    *   –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±–µ—Ä–µ—Ç –Ω–∞ —Å–µ–±—è –≤–µ—Å—å —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:
        1.  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ, —Å—Ö–µ–º–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) –º–æ–¥–µ–ª–∏ –≤–º–µ—Å—Ç–µ —Å –≤–∞—à–∏–º –∑–∞–ø—Ä–æ—Å–æ–º.
        2.  –ï—Å–ª–∏ –º–æ–¥–µ–ª—å —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –æ–Ω–∞ –≤–µ—Ä–Ω–µ—Ç –æ—Ç–≤–µ—Ç —Å `finish_reason: 'tool_calls'` –∏ —Å–ø–∏—Å–∫–æ–º `tool_calls`.
        3.  –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ (`toolCall`):
            *   –ù–∞—Ö–æ–¥–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –≤–∞—à–µ–º –º–∞—Å—Å–∏–≤–µ `tools` –ø–æ –∏–º–µ–Ω–∏.
            *   –ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ (`toolCall.function.arguments`) –≤ JavaScript-–æ–±—ä–µ–∫—Ç.
            *   –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–æ JSON Schema, —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ `tool.function.parameters` (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å).
            *   **–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** —á–µ—Ä–µ–∑ `SecurityManager` (–µ—Å–ª–∏ –æ–Ω —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω): –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`userInfo`) –∫ —ç—Ç–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É, –ø—Ä–∏–º–µ–Ω—è–µ—Ç rate-–ª–∏–º–∏—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞ –æ–ø–∞—Å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.
            *   –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é `tool.execute(parsedArgs, context)`.
            *   –î–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–∏–ª–∏ –ª–æ–≤–∏—Ç –æ—à–∏–±–∫—É) –æ—Ç –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ `execute`.
            *   **–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ—à–∏–±–∫—É) –≤ JSON-—Å—Ç—Ä–æ–∫—É** –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –º–æ–¥–µ–ª–∏ –≤ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å `role: 'tool'` –∏ `tool_call_id`.
        4.  –ú–æ–¥–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π, –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—É–∂–µ —Å `role: 'assistant'`).
    *   –û–ø—Ü–∏—è `maxToolCalls` –≤ `client.chat()` –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫–∏—Ö —Ü–∏–∫–ª–æ–≤ "–∑–∞–ø—Ä–æ—Å-–≤—ã–∑–æ–≤-—Ä–µ–∑—É–ª—å—Ç–∞—Ç", —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
    *   –û–ø—Ü–∏—è `toolChoice` –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—ã–±–æ—Ä–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –º–æ–¥–µ–ª—å—é: `'auto'` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), `'none'` (–∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—ã–∑–æ–≤), –∏–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `{ type: "function", function: { name: "my_tool_name" } }`.

3.  **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤) –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–æ–ª–µ `ChatCompletionResult.content`. –ü–æ–ª–µ `ChatCompletionResult.toolCallsCount` –ø–æ–∫–∞–∂–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–Ω—ã –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `client.chat()`.

#### üîí –ú–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`SecurityManager`)

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∑–∞—â–∏—Ç—É –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, —á—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ, –µ—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º. –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–µ–π –æ–±—ä–µ–∫—Ç–∞ `security: SecurityConfig` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `OpenRouterClient`.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

*   `AuthManager`: –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JWT. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç (`createAccessToken`) –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç (`authenticateUser`) —Ç–æ–∫–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `jwtSecret` –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ —á–µ—Ä–µ–∑ `customAuthenticator`.
*   `AccessControlManager`: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–ª–∏ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ) –ø—Ä–∞–≤–æ –≤—ã–∑—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ `security.toolAccess` –∏ `security.roles`. –£—á–∏—Ç—ã–≤–∞–µ—Ç `defaultPolicy`.
*   `RateLimitManager`: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ —á–∞—Å—Ç–æ—Ç—É –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –ª–∏–º–∏—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`security.roles`, `security.toolAccess` –∏–ª–∏ `tool.security`). **–í–∞–∂–Ω–æ:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ –∏ **–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º**.
*   `ArgumentSanitizer`: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –≤ `execute` —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –∏–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ø—ã—Ç–∫–∏ SQL-–∏–Ω—ä–µ–∫—Ü–∏–π, XSS, –∫–æ–º–∞–Ω–¥ –û–°). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –∏–∑ `security.dangerousArguments`. –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∂–∏–º–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –∞—É–¥–∏—Ç–∞ (`auditOnlyMode`).

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`SecurityConfig`):**

–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–¥—É–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã (`ExtendedSecurityConfig`, `ExtendedUserAuthInfo` –∏ —Ç.–¥.), —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:

*   `defaultPolicy` (`'deny-all'` | `'allow-all'`): –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞? –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è `'deny-all'`.
*   `requireAuthentication` (boolean): –¢—Ä–µ–±–æ–≤–∞—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π `accessToken` –¥–ª—è *–ª—é–±–æ–≥–æ* –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞?
*   `allowUnauthenticatedAccess` (boolean): –ï—Å–ª–∏ `requireAuthentication: false`, —Ä–∞–∑—Ä–µ—à–∞—Ç—å –ª–∏ –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–Ω–æ–Ω–∏–º–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–µ—Å–ª–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∑–∞–¥–∞–Ω–æ `allow: true` –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ä–æ–ª–µ–π/scopes)?
*   `userAuthentication` (`UserAuthConfig`): –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–æ—Å–æ–±–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (`type: 'jwt'`, `jwtSecret`, `customAuthenticator`). **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π `jwtSecret`, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JWT!**
*   `toolAccess` (`Record<string, ToolAccessConfig>`): –ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–ø–æ –∏–º–µ–Ω–∏) –∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö (`'*'`). –í–∫–ª—é—á–∞–µ—Ç `allow`, `roles`, `scopes`, `rateLimit`, `allowedApiKeys`.
*   `roles` (`RolesConfig`): –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π –∏ –∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π (`allowedTools`, `rateLimits`).
*   `dangerousArguments` (`ExtendedDangerousArgumentsConfig`): –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (`globalPatterns`, `toolSpecificPatterns`, `blockedValues`, `auditOnlyMode`).

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

1.  –ü–µ—Ä–µ–¥–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç `securityConfig` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `OpenRouterClient`.
2.  –î–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –≤ `client.chat({ accessToken: '...' })`.
3.  –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑–æ–≤–µ—Ç `securityManager.checkToolAccessAndArgs()`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ª–∏–º–∏—Ç—ã, –∞—Ä–≥—É–º–µ–Ω—Ç—ã).
4.  –ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª –±—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –æ—à–∏–±–∫–∞ (`AuthorizationError`, `AccessDeniedError`, `RateLimitError`, `SecurityError`), –∏ –≤—ã–∑–æ–≤ `execute` –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç.
5.  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `client.createAccessToken()` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JWT (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ).
6.  –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`client.on('access:denied', ...)` –∏ –¥—Ä.) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

#### üìà –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Cost Tracking)

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å **–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é** –æ—Ü–µ–Ω–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ `client.chat()` –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Ü–µ–Ω –Ω–∞ –º–æ–¥–µ–ª–∏ OpenRouter.

*   **–í–∫–ª—é—á–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `enableCostTracking: true` –≤ `OpenRouterConfig`.
*   **–ú–µ—Ö–∞–Ω–∏–∑–º:**
    1.  –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä `CostTracker`.
    2.  `CostTracker` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ OpenRouter API `/models`. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã `initialModelPrices`) –∏ –∑–∞—Ç–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∏–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–¥–∞–µ—Ç—Å—è `priceRefreshIntervalMs`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 6 —á–∞—Å–æ–≤).
    3.  –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã (—Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –º–∏–ª–ª–∏–æ–Ω –≤—Ö–æ–¥–Ω—ã—Ö –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤) –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏.
    4.  –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `client.chat()`, –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞—Ö (`usage`) –∏–∑ –æ—Ç–≤–µ—Ç–∞ API.
    5.  –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `costTracker.calculateCost(model, usage)`, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏ –¥–∞–Ω–Ω—ã–µ `usage` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ–º–ø—Ç–∞, —Ç–∞–∫ –∏ –æ—Ç–≤–µ—Ç–∞, –∞ —Ç–∞–∫–∂–µ —Ç–æ–∫–µ–Ω—ã, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏).
    6.  –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—á–∏—Å–ª–æ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê) –∏–ª–∏ `null` (–µ—Å–ª–∏ —Ü–µ–Ω—ã –¥–ª—è –º–æ–¥–µ–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã –∏–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ) –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø–æ–ª–µ `cost` –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ `ChatCompletionResult`.
*   **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–ª–∏–µ–Ω—Ç–∞:**
    *   `getCreditBalance(): Promise<CreditBalance>`: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ OpenRouter.
    *   `getModelPrices(): Record<string, ModelPricingInfo>`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∫—ç—à —Ü–µ–Ω –º–æ–¥–µ–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Ç—Ä–µ–∫–µ—Ä–æ–º.
    *   `refreshModelPrices(): Promise<void>`: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ —Ü–µ–Ω –º–æ–¥–µ–ª–µ–π.
    *   `getCostTracker(): CostTracker | null`: –î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —ç–∫–∑–µ–º–ø–ª—è—Ä—É `CostTracker` (–µ—Å–ª–∏ –æ–Ω –≤–∫–ª—é—á–µ–Ω).
*   **–¢–æ—á–Ω–æ—Å—Ç—å:** –°–ª–µ–¥—É–µ—Ç –ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ —ç—Ç–æ **–æ—Ü–µ–Ω–∫–∞**. –†–µ–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –∏–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–π –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ü–µ–Ω–æ–≤–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ OpenRouter, –Ω–µ –æ—Ç—Ä–∞–∂–µ–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ.

#### ‚öôÔ∏è –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (`responseFormat`)

–ü–æ–∑–≤–æ–ª—è–µ—Ç —É–∫–∞–∑–∞—Ç—å –º–æ–¥–µ–ª–∏, —á—Ç–æ –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

*   **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –ó–∞–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ–ø—Ü–∏—é `responseFormat` –≤ `OpenRouterConfig` (–¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏–ª–∏ –≤ `options` –º–µ—Ç–æ–¥–∞ `client.chat()` (–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞).
*   **–¢–∏–ø—ã:**
    *   `{ type: 'json_object' }`: –£–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –ª—é–±–æ–π –≤–∞–ª–∏–¥–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç.
    *   `{ type: 'json_schema', json_schema: { name: string, schema: object, strict?: boolean, description?: string } }`: –¢—Ä–µ–±—É–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –≤–µ—Ä–Ω—É—Ç—å JSON, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π JSON Schema.
        *   `name`: –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –≤–∞—à–µ–π —Å—Ö–µ–º—ã.
        *   `schema`: –û–±—ä–µ–∫—Ç JSON Schema, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–∂–∏–¥–∞–µ–º–æ–≥–æ JSON.
        *   `strict` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –¢—Ä–µ–±–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ö–µ–º–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –º–æ–¥–µ–ª—å—é).
        *   `description` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ö–µ–º—ã –¥–ª—è –º–æ–¥–µ–ª–∏.
*   **–ü—Ä–∏–º–µ—Ä:**
    ```typescript
    import { OpenRouterClient, MemoryHistoryStorage } from 'openrouter-kit';

    const client = new OpenRouterClient({ /* ... */ historyAdapter: new MemoryHistoryStorage() });

    const userSchema = {
      type: "object",
      properties: { name: { type: "string"}, age: {type: "number"} },
      required: ["name", "age"]
    };

    async function getUserData() {
        const result = await client.chat({
          prompt: '–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π JSON –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –∏–º—è –ê–ª–∏—Å–∞, –≤–æ–∑—Ä–∞—Å—Ç 30.',
          responseFormat: {
            type: 'json_schema',
            json_schema: { name: 'UserData', schema: userSchema }
          }
        });
        console.log(result.content); // –û–∂–∏–¥–∞–µ–º { name: "–ê–ª–∏—Å–∞", age: 30 }
    }
    ```
*   **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
    *   –ï—Å–ª–∏ –æ–ø—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ `strictJsonParsing: false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –∏–ª–∏ JSON, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ö–µ–º–µ, –ø–æ–ª–µ `ChatCompletionResult.content` –±—É–¥–µ—Ç `null`.
    *   –ï—Å–ª–∏ –æ–ø—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ `strictJsonParsing: true`: –í –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –±—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω–∞ –æ—à–∏–±–∫–∞ `ValidationError`.
*   **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–æ–¥–µ–ª—è–º–∏:** –ù–µ –≤—Å–µ –º–æ–¥–µ–ª–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç `responseFormat`. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏.

#### ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

*   **–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `OpenRouterError`**: –í—Å–µ –æ—à–∏–±–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç –Ω–µ–≥–æ. –°–æ–¥–µ—Ä–∂–∏—Ç:
    *   `message`: –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏.
    *   `code` (`ErrorCode`): –°—Ç—Ä–æ–∫–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `API_ERROR`, `VALIDATION_ERROR`, `RATE_LIMIT_ERROR`).
    *   `statusCode?` (number): HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞ API, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
    *   `details?` (any): –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞.
*   **–ü–æ–¥–∫–ª–∞—Å—Å—ã**: –î–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–¥–∫–ª–∞—Å—Å—ã, —Ç–∞–∫–∏–µ –∫–∞–∫:
    *   `APIError`: –û—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–∞—è API OpenRouter (—Å—Ç–∞—Ç—É—Å >= 400).
    *   `ValidationError`: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–∫–æ–Ω—Ñ–∏–≥, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –æ—Ç–≤–µ—Ç JSON/—Å—Ö–µ–º–∞).
    *   `NetworkError`: –°–µ—Ç–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å API.
    *   `AuthenticationError`: –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º (–æ–±—ã—á–Ω–æ 401).
    *   `AuthorizationError`: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ (–æ–±—ã—á–Ω–æ 401).
    *   `AccessDeniedError`: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ (–æ–±—ã—á–Ω–æ 403).
    *   `RateLimitError`: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—ã—á–Ω–æ 429). –°–æ–¥–µ—Ä–∂–∏—Ç `details.timeLeft` (ms).
    *   `ToolError`: –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `execute` —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
    *   `ConfigError`: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
    *   `SecurityError`: –û–±—â–∞—è –æ—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–≤–∫–ª—é—á–∞—è `DANGEROUS_ARGS`).
    *   `TimeoutError`: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç API.
*   **–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ `ErrorCode`**: –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫ (`ErrorCode.API_ERROR`, `ErrorCode.TOOL_ERROR` –∏ —Ç.–¥.).
*   **–§—É–Ω–∫—Ü–∏—è `mapError(error)`**: –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ Axios –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö `Error` –≤ `OpenRouterError`. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
*   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ**:
    *   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–ª–æ–∫–∏ `try...catch` –≤–æ–∫—Ä—É–≥ –≤—ã–∑–æ–≤–æ–≤ –º–µ—Ç–æ–¥–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ (`client.chat()`, `client.getCreditBalance()` –∏ –¥—Ä.).
    *   –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–∏–ø –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `instanceof` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `if (error instanceof RateLimitError)`) –∏–ª–∏ –ø–æ –∫–æ–¥—É (`if (error.code === ErrorCode.VALIDATION_ERROR)`).
    *   –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ `error.statusCode` –∏ `error.details` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
    *   –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ `'error'` –∫–ª–∏–µ–Ω—Ç–∞ (`client.on('error', handler)`) –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫.

```typescript
import { OpenRouterClient, MemoryHistoryStorage, OpenRouterError, RateLimitError, ValidationError, ErrorCode } from 'openrouter-kit';

const client = new OpenRouterClient({ /* ... */ historyAdapter: new MemoryHistoryStorage() });

async function safeChat() {
    try {
      const result = await client.chat({ prompt: "..." });
      // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ...
    } catch (error: any) {
      if (error instanceof RateLimitError) {
        const retryAfter = Math.ceil((error.details?.timeLeft || 1000) / 1000); // –°–µ–∫—É–Ω–¥—ã
        console.warn(`–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ ${retryAfter} —Å–µ–∫.`);
      } else if (error.code === ErrorCode.VALIDATION_ERROR) {
        console.error(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${error.message}`, error.details);
      } else if (error.code === ErrorCode.TOOL_ERROR && error.message.includes('Maximum tool call depth')) {
         console.error(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: ${error.message}`);
      } else if (error instanceof OpenRouterError) {
        console.error(`–û—à–∏–±–∫–∞ OpenRouter Kit (${error.code}, Status: ${error.statusCode || 'N/A'}): ${error.message}`);
        if(error.details) console.error('–î–µ—Ç–∞–ª–∏:', error.details);
      } else {
        console.error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
      }
    } finally {
        await client.destroy();
    }
}
```

#### üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ —Å–æ–±—ã—Ç–∏—è—Ö.

*   **–ê–∫—Ç–∏–≤–∞—Ü–∏—è:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `debug: true` –≤ `OpenRouterConfig` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞.
*   **–£—Ä–æ–≤–Ω–∏:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∫–æ–Ω—Å–æ–ª–∏: `console.debug`, `console.log`, `console.warn`, `console.error`. –í —Ä–µ–∂–∏–º–µ `debug: false` –≤—ã–≤–æ–¥—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –æ—à–∏–±–∫–∏, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
*   **–ü—Ä–µ—Ñ–∏–∫—Å—ã:** –°–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∞–±–∂–∞—é—Ç—Å—è –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏, —É–∫–∞–∑—ã–≤–∞—é—â–∏–º–∏ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `[OpenRouterClient]`, `[SecurityManager]`, `[CostTracker]`, `[UnifiedHistoryManager]`), —á—Ç–æ –æ–±–ª–µ–≥—á–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É.
*   **–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è:** –•–æ—Ç—è –Ω–∞–ø—Ä—è–º—É—é –∑–∞–º–µ–Ω–∞ –ª–æ–≥–≥–µ—Ä–∞ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º API, –≤—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–≤–æ–π –ª–æ–≥–≥–µ—Ä –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `HistoryManager`, –µ—Å–ª–∏ –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞–≥–∏–Ω—ã/middleware –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤.
*   **–ú–µ—Ç–æ–¥ `isDebugMode()`:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ (`client.isDebugMode()`).

#### üåê –ü—Ä–æ–∫—Å–∏

–î–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenRouter API —á–µ—Ä–µ–∑ HTTP/HTTPS –ø—Ä–æ–∫—Å–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ü–∏—é `proxy` –≤ `OpenRouterConfig`.

*   **–§–æ—Ä–º–∞—Ç—ã:**
    *   **URL –°—Ç—Ä–æ–∫–∞:** –ü–æ–ª–Ω—ã–π URL –ø—Ä–æ–∫—Å–∏, –≤–∫–ª—é—á–∞—è –ø—Ä–æ—Ç–æ–∫–æ–ª, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, —Ö–æ—Å—Ç –∏ –ø–æ—Ä—Ç.
        ```typescript
        proxy: 'http://user:password@proxy.example.com:8080'
        ```
        ```typescript
        proxy: 'https://secureproxy.com:9000'
        ```
    *   **–û–±—ä–µ–∫—Ç:** –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏:
        *   `host` (string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): –•–æ—Å—Ç –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞.
        *   `port` (number | string, **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**): –ü–æ—Ä—Ç –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞.
        *   `user?` (string, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–∫—Å–∏.
        *   `pass?` (string, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ü–∞—Ä–æ–ª—å –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–∫—Å–∏.
        ```typescript
        proxy: {
          host: '192.168.1.100',
          port: 8888,
          user: 'proxyUser',
          pass: 'proxyPassword'
        }
        ```
*   **–ú–µ—Ö–∞–Ω–∏–∑–º:** –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `https-proxy-agent` –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ HTTPS-—Ç—Ä–∞—Ñ–∏–∫–∞ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω—ã–π HTTP/HTTPS –ø—Ä–æ–∫—Å–∏.

### üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

[MIT](./LICENSE)